/**
 * Shared type definitions for the entire application
 * Defines common data structures used across modules
 * Uses TypeScript types exclusively (no interfaces) per project standards
 */

import {z} from 'zod';

/**
 * Stock data point with date information
 */
export const StockDataPointSchema = z.object({
	date: z.string(),
	open: z.number(),
	high: z.number(),
	low: z.number(),
	close: z.number(),
	volume: z.number(),
	adjClose: z.number(),
});

export type StockDataPoint = z.infer<typeof StockDataPointSchema>;

/**
 * Normalized stock data with numeric timestamp
 */
export type NormalizedStockData = {
	timestamp: number;
	price: number;
	volume: number;
	high: number;
	low: number;
};

/**
 * Model training result with performance metrics
 */
export type TrainingResult = {
	loss: number;
	accuracy: number;
	meanAbsoluteError: number;
	rootMeanSquaredError: number;
	epochs: number;
	trainingTime: number;
	isValid: boolean;
};

/**
 * Model performance metrics
 */
export type ModelPerformance = {
	loss: number;
	accuracy: number;
	meanAbsoluteError: number;
	rootMeanSquaredError: number;
	isValid: boolean;
	lastTrained: Date;
	dataPoints: number;
	version: string;
};

/**
 * Prediction result for a stock symbol
 */
export type PredictionResult = {
	symbol: string;
	currentPrice: number;
	predictedPrice: number;
	priceChange: number;
	percentChange: number;
	predictionDate: Date;
	days: number;
	historicalData: StockDataPoint[];
	predictedData: {date: string; price: number}[];
	predictedPrices: number[]; // Added back for compatibility
	confidence: number;
	meanAbsoluteError: number;
};

/**
 * Trading signal generated by prediction engine
 */
export type TradingSignal = {
	symbol: string;
	action: 'BUY' | 'SELL' | 'HOLD';
	confidence: number;
	delta: number; // Added back for compatibility
	reason: string; // Added back for compatibility
	timestamp: Date;
};

/**
 * Report prediction data
 */
export type ReportPrediction = {
	symbol: string;
	name: string;
	prediction: PredictionResult;
	signal: TradingSignal['action'];
	confidence: number;
};

/**
 * Chart data point for visualization
 */
export type ChartDataPoint = {
	date: string;
	price: number;
	predicted?: number;
	volume?: number;
};

/**
 * Report generation context
 */
export type ReportContext = {
	title: string;
	generatedAt: string;
	totalSymbols: number;
	predictedSymbols: number;
	buySignals: number;
	sellSignals: number;
	holdSignals: number;
	averageConfidence: number;
};

/**
 * Progress tracking status
 */
export type ProgressStatus =
	| 'pending'
	| 'updated'
	| 'up-to-date'
	| 'error'
	| 'trained'
	| 'no-new-data'
	| 'poor-performance'
	| 'retrained'
	| 'no-improvement'
	| 'predicted';

/**
 * ML configuration
 */
export type MlConfig = {
	modelType: 'lstm' | 'regression';
	windowSize: number;
	epochs: number;
	learningRate: number;
	batchSize: number;
};

/**
 * Trading configuration
 */
export type TradingConfig = {
	buyThreshold: number;
	sellThreshold: number;
	minConfidence: number;
};

/**
 * API configuration
 */
export type ApiConfig = {
	timeout: number;
	retries: number;
	rateLimit: number;
};

/**
 * Database configuration
 */
export type DatabaseConfig = {
	type: 'json' | 'sqlite';
	path: string;
	modelsPath: string;
};

/**
 * Output configuration
 */
export type OutputConfig = {
	directory: string;
	template: string;
	includeCharts: boolean;
	chartsType: 'line' | 'candlestick' | 'both';
};

/**
 * Error context for error handling
 */
export type ErrorContext = {
	operation: string;
	symbol?: string;
	step?: string;
	additionalInfo?: Record<string, unknown>;
};

/**
 * Yahoo Finance Quote response schema
 */
export const YahooQuoteSchema = z.object({
	regularMarketPrice: z.number(),
	currency: z.string(),
	longName: z.string().optional(),
	shortName: z.string().optional(),
});

/**
 * Data export/import schema
 */
export const ImportExportSchema = z.object({
	version: z.string(),
	exportedAt: z.string(),
	symbols: z.array(
		z.object({
			symbol: z.string(),
			name: z.string(),
		}),
	),
	historical_data: z.array(
		z.object({
			symbol: z.string(),
			date: z.string(),
			open: z.number(),
			high: z.number(),
			low: z.number(),
			close: z.number(),
			volume: z.number(),
			adjClose: z.number(),
		}),
	),
	models_metadata: z.array(
		z.object({
			symbol: z.string(),
			version: z.string(),
			trainedAt: z.string(),
			dataPoints: z.number(),
			loss: z.number(),
			windowSize: z.number(),
			metrics: z.string(),
		}),
	),
});
